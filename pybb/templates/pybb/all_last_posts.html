{% extends 'pybb/base.html' %}

{% block title %}
    Latest posts - {{ block.super }}
{% endblock title %}

{% block content_header %}
    <h1>Latest Posts</h1>
{% endblock %}

{% block content_main %}
<div class="blogEntry">

    <form action="." method="post" novalidate>
        {% csrf_token %}
        <span class="errormessage">{{ form.days.errors }}</span>
        <label for="id_days">Show posts created up to 
            {{ form.days }} days ago. </label>
        <span class="errormessage">{{ form.sort_by.errors }}</span>
        {{ form.sort_by.label_tag }} {{ form.sort_by }}
        <input type="submit" value="Submit" />
        {% if form.errors %}
          <p class="errormessage">
            An error occured, some default values are used.
            Please correct the errors above to get valuable results.
          </p>
        {% else %}
          <p>
            Found {{ posts|length }} posts. The list is always sorted by the most recent post first.
          </p>
        {% endif %}
    </form>

    <hr>

    {% if sort_by == 'topic' %}
      {% regroup posts by topic as topic_list %}
      {% for topic, posts in topic_list %}
        <h2>{{ topic }}</h2>
        <p>At Forum:
          <a href="{% url 'pybb_forum' posts.0.topic.forum.id %}">{{ posts.0.topic.forum }}</a>
        </p>
        {% include 'pybb/inlines/latest_posts_table.html'%}
      {% endfor %}
    {% else %} {# sort by forum #}
      {% regroup posts by topic.forum as forum_list %}
       {% for forum, posts in forum_list %}
        <h2>{{ forum }}</h2>
        {% regroup posts by topic as topic_list %}
        <table class='forum'>
          <thead>
            <tr>
              <th style="text-align: left; width: 30%;">Topic{{ topic_list|length|pluralize }}</th>
              <th style="text-align: left;">Post{{ posts|length|pluralize }}</th>
            </tr>
          </thead>
          <tbody>
          {% for topic, posts in topic_list %}
            <tr class={% cycle 'odd' 'even' %}>
              <td class='post'>
                <a href="{% url 'pybb_topic' posts.0.topic.id %}">{{ posts.0.topic }}</a>
              </td>
              <td>
                  {% include 'pybb/inlines/latest_posts_table.html'%}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% empty %}
        <p>Sorry, no posts found...</p>
      {% endfor %}
    {% endif %}
</div>
{% endblock %}
